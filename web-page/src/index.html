<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XZG Multi-tool</title>
    <meta name="color-scheme" content="light dark" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script>
        // Early theme bootstrap: use cookie if set, otherwise system preference
        (function () {
            try {
                var m = document.cookie.match(/(?:^|; )theme=(light|dark)/);
                var cookieTheme = m ? m[1] : null;
                var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                var theme = cookieTheme || (prefersDark ? 'dark' : 'light');
                if (theme === 'dark') document.documentElement.classList.add('dark');
                document.documentElement.style.colorScheme = theme;
            } catch (e) { /* no-op */ }
        })();
    </script>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JX4GN8MT8G"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-JX4GN8MT8G');
</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S60TKXM4SV"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-S60TKXM4SV');
</script>

<body>
    <div class="container" style="max-width: 860px">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h4 m-0">
                <img src="fav/favicon.svg" alt="XZG logo" class="me-2"
                    style="height:1.5em;width:auto;vertical-align:middle" />
                <span style="width:auto;vertical-align:middle">XZG Multi-tool</span>
            </h1>
            <div class="theme-toggle" title="Toggle theme">
                <input id="themeSwitch" type="checkbox" aria-label="Toggle theme" />
                <label class="theme-toggle-label" for="themeSwitch">
                    <i class="bi bi-sun-fill"></i>
                    <span class="handle"></span>
                    <i class="bi bi-moon-stars-fill"></i>
                </label>
            </div>
        </div>

        <div class="section">
            <div class="row g-3 align-items-stretch">
                <!-- Serial column -->
                <div id="serialSection" class="col-md-6 d-flex flex-column">
                    <div class="d-flex align-items-center justify-content-between mb-2" style="height:2em">
                        <h3 class="h6 m-0"><i class="bi bi-usb-symbol me-1"></i>Serial</h3>
                    </div>

                    <div id="serialControlsWrap">
                        <!-- Serial controls will be shown/hidden by JS depending on protocol -->
                        <div id="serialMobileMsg" class="serial-note alert alert-secondary d-none mb-2" role="status">
                            Web Serial is not available on mobile devices, but you can use TCP mode üöÄ
                        </div>
                        <div class="serial-controls mb-2">

                            <div class="row g-2 align-items-center mb-4">
                                <div class="col d-flex justify-content-center">
                                    <div class="col-auto">
                                        <label class="col-form-label px-2" for="bitrateInput">Baud</label>
                                    </div>
                                    <div class="col-auto">
                                        <select id="bitrateInput" class="form-select" style="width:160px">
                                            <option value="9600">9600</option>
                                            <option value="19200">19200</option>
                                            <option value="38400">38400</option>
                                            <option value="57600">57600</option>
                                            <option value="115200" selected>115200</option>
                                            <option value="230400">230400</option>
                                            <option value="460800">460800</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 mb-4">
                                <div id="autoBslWrap" class="d-flex align-items-center justify-content-center gap-2">
                                    <div
                                        class="form-check form-switch d-flex align-items-center justify-content-center">
                                        <input id="autoBslToggle" class="form-check-input" type="checkbox" role="switch"
                                            aria-label="Auto BSL" checked />
                                    </div>
                                    <span class="text-muted">Auto BSL</span>
                                    <!-- Help tooltip for Auto BSL -->
                                    <button id="autoBslHelp" type="button" class="btn btn-sm btn-link p-0 ms-2"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        data-bs-trigger="hover focus click" data-bs-html="true"
                                        data-bs-title="<strong>Auto BSL:</strong> Automatically puts the device into the Bootloader (BSL) before flashing and returns it to normal mode after.<br><strong>Disable</strong> if you prefer to enter BSL manually.">
                                        <i class="bi bi-info-circle" aria-hidden="true"></i>
                                        <span class="visually-hidden">Help</span>
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-auto">
                                <div class="col d-flex justify-content-center">
                                    <button id="chooseSerial" class="btn btn-primary">
                                        <i class="bi bi-usb-plug-fill me-1"></i>Choose Serial
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Message for HTTP mode -->
                        <div id="serialHttpMsg" class="alert alert-secondary text-center d-none" role="status">
                            <span style="font-size:1.2em;">‚ö°Ô∏è Web Serial unavailable!</span><br>
                            To use Web Serial:<br>
                            üåê Open <a href="https://mt.xyzroe.cc">https://mt.xyzroe.cc</a><br>
                            üñ•Ô∏è Or access via <a href="http://localhost:8765">localhost</a> (if
                            possible)
                        </div>
                    </div>
                </div>
                <!-- TCP column -->
                <div id="tcpSection" class="col-md-6 d-flex flex-column">
                    <div class="d-flex align-items-center justify-content-between mb-2" style="height:2em">
                        <h3 class="h6 m-0"><i class="bi bi-diagram-3 me-1"></i>TCP<span id="bridgeStatusIcon"
                                class="align-self-center text-danger m-2" title="Bridge status">
                                <i class="bi bi-x-circle-fill"></i>
                            </span></h3>
                        <div class="d-flex gap-2">
                            <button id="tcpInfoBtn" class="btn btn-outline-info btn-sm" title="Bridge info">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <button id="tcpSettingsBtn" class="btn btn-outline-secondary btn-sm"
                                title="Bridge settings">
                                <i class="bi bi-gear"></i>
                            </button>
                        </div>
                    </div>
                    <div id="tcpControlsWrap">
                        <!-- TCP controls will be shown/hidden by JS depending on protocol -->
                        <div id="tcpSettingsPanel" class="mb-2 d-none">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-8">
                                    <input id="bridgeHostInput" class="form-control"
                                        placeholder="IP (e.g. 192.168.1.10)" value="127.0.0.1" />
                                </div>
                                <div class="col-md-4">
                                    <input id="bridgePortInput" class="form-control" type="number"
                                        placeholder="Port (e.g. 8765)" value="8765" />
                                </div>
                            </div>
                            <div class="small text-muted mt-1">WS‚ÜíTCP bridge address</div>
                        </div>
                        <div class="row g-2 align-items-center mb-4" title="Discovered via mDNS (zeroconf)">
                            <div class="col-12 d-flex gap-2">
                                <select id="mdnsSelect" class="form-select">
                                    <option value="">‚Äî Discovered devices ‚Äî</option>
                                </select>
                                <button id="mdnsRefresh" class="btn btn-outline-secondary" title="Refresh mDNS">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row g-2 align-items-center mb-4" title="TCP target via local ws bridge">
                            <div class="col-md-8"><input id="hostInput" class="form-control"
                                    placeholder="IP (e.g. 192.168.1.100)" />
                            </div>
                            <div class="col-md-4"><input id="portInput" class="form-control" type="number"
                                    placeholder="Port (e.g. 6638)" value="6638" /></div>
                        </div>
                        <!-- Control strategy: Pin vs Mode -->
                        <div class="col-12 mb-4">
                            <div id="pinModeWrap" class="d-flex align-items-center justify-content-center gap-2"
                                title="Choose Pin control or Mode control">
                                <span class="text-muted">Pin</span>
                                <div class="form-check form-switch d-flex align-items-center justify-content-center">
                                    <input id="pinModeSelect" class="form-check-input" type="checkbox" role="switch" />
                                </div>
                                <span class="text-muted">Mode</span>
                                <!-- Bootstrap tooltip trigger -->
                                <button id="pinModeHelp" type="button" class="btn btn-sm btn-link p-0 ms-2"
                                    data-bs-toggle="tooltip" data-bs-placement="top" data-bs-trigger="hover focus click"
                                    data-bs-html="true"
                                    data-bs-title="<strong>Pin:</strong> Use when the device exposes endpoints to drive Zigbee chip pins directly (RST, BSL).<br><strong>Mode:</strong> Use when the device provides endpoints that perform a sequence to enter the desired mode.">
                                    <i class="bi bi-info-circle" aria-hidden="true"></i>
                                    <span class="visually-hidden">Help</span>
                                </button>
                            </div>
                        </div>
                        <!-- Unified control URLs (behavior depends on Pin/Mode switch) -->
                        <div id="ctrlUrlRow" class="row g-2 align-items-center mb-4">
                            <div class="col-12 col-md-12">
                                <input id="bslUrlInput" class="form-control" placeholder="BSL URL" />
                            </div>
                            <div class="col-12 col-md-12">
                                <input id="rstUrlInput" class="form-control" placeholder="RST URL" />
                            </div>
                            <div class="col-12 col-md-12">
                                <input id="baudUrlInput" class="form-control" placeholder="Baud URL" />
                            </div>
                            <div class="col-12 small text-muted">
                                <div>Placeholders: {HOST}, {PORT}, {BRIDGE}, {SET}.</div>
                            </div>
                        </div>
                        <div class="row mt-auto">
                            <div class="col d-flex justify-content-center">
                                <button id="connectTcp" class="btn btn-secondary">
                                    <i class="bi bi-link-45deg me-1"></i>Connect
                                </button>
                            </div>
                        </div>
                        <!-- Message for HTTPS mode -->
                        <div id="tcpHttpsMsg" class="alert alert-secondary text-center d-none" role="status">
                            <span style="font-size:1.2em;">‚ö°Ô∏è TCP/WS unavailable!</span><br>
                            To use TCP/WS:<br>
                            üåê Open <a href="http://nmt.xyzroe.cc">http://nmt.xyzroe.cc</a><br>
                            üñ•Ô∏è Or access via <a id="tcpLocalhostLink" href=""></a><br>
                            (WS-TCP Bridge address)
                        </div>
                    </div>
                </div>
            </div>
            <!-- Disconnect button centered below the two columns -->
            <div class="row mt-3 justify-content-center">
                <div class="col-auto d-flex justify-content-center">
                    <button id="disconnectBtn" class="btn btn-outline-secondary btn-lg d-none">
                        <i class="bi bi-power me-1"></i>Disconnect
                    </button>
                </div>
            </div>

        </div>

        <div class="section">
            <h2 class="h6">Device Info <span id="deviceDetectSpinner"
                    class="spinner-border spinner-border-sm align-text-top ms-2 d-none" role="status"
                    aria-hidden="true"></span>
            </h2>
            <div class="row g-2 form-readonly mb-2">
                <div class="col-md-6">
                    <label class="form-label">Port</label>
                    <input id="portInfo" class="form-control" type="text" readonly />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Model</label>
                    <input id="chipModel" class="form-control" type="text" readonly />
                </div>
            </div>
            <div class="row g-2 form-readonly">

                <div class="col-md-4">
                    <label class="form-label">Flash Size</label>
                    <input id="flashSize" class="form-control" type="text" readonly />
                </div>
                <div class="col-md-4">
                    <label class="form-label">IEEE</label>
                    <input id="ieeeMac" class="form-control" type="text" readonly />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Firmware</label>
                    <input id="firmwareVersion" class="form-control" type="text" readonly />
                </div>
            </div>
        </div>


        <div id="firmwareSection" class="section opacity-50 pe-none" aria-disabled="true">
            <h2 class="h6">Firmware</h2>
            <div class="row g-3">
                <div class="col-md-6">
                    <h3 class="h6 mb-2"><i class="bi bi-folder me-1"></i>Local</h3>
                    <input id="hexFile" class="form-control" type="file" accept=".hex,.txt,.bin" />
                    <div class="small text-muted mt-1">Use a local file (*.hex or *.bin). Check your chip model.
                    </div>
                </div>
                <div class="col-md-6" title="Load firmware list from GitHub by detected chip model">
                    <h3 class="h6 mb-2"><i class="bi bi-cloud me-1"></i>Cloud</h3>
                    <div class="d-flex gap-2">
                        <select id="netFwSelect" class="form-select">
                            <option value="">‚Äî Network firmware (select after detection) ‚Äî</option>
                        </select>
                        <button id="netFwNotesBtn" class="btn btn-outline-info" disabled title="Show firmware info">
                            <i class="bi bi-info-circle"></i>
                        </button>
                        <button id="netFwRefresh" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                    <div class="small text-muted mt-1">Source: xyzroe/XZG, filtered by your chip model.</div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col d-flex justify-content-center">
                    <div class="d-flex align-items-center gap-4">
                        <div class="form-check m-0">
                            <input id="optErase" class="form-check-input" type="checkbox" checked />
                            <label class="form-check-label" for="optErase">Erase</label>
                        </div>
                        <div class="form-check m-0">
                            <input id="optWrite" class="form-check-input" type="checkbox" />
                            <label class="form-check-label" for="optWrite">Write</label>
                        </div>
                        <div class="form-check m-0">
                            <input id="optVerify" class="form-check-input" type="checkbox" />
                            <label class="form-check-label" for="optVerify">Verify</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col d-flex justify-content-center">
                    <button id="btnFlash" class="btn btn-success btn-lg">
                        <i class="bi bi-lightning-charge me-1"></i>Start
                    </button>
                </div>
            </div>
            <div class="row g-2 mt-3">
                <div class="col">
                    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"
                        style="height: 1.25rem;">
                        <div id="progress" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="nvramSection" class="section opacity-50 pe-none" aria-disabled="true">
            <h2 class="h6">NVRAM</h2>
            <div class="small text-muted mb-2">Backup and restore device NVRAM (Legacy OSAL + Extended NV). Use with
                caution.
            </div>
            <!-- File picker is opened programmatically on Write button click -->
            <div class="row g-2 align-items-end mb-2">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-evenly w-100 nv-actions">
                        <button id="btnNvRead" class="btn btn-outline-primary">
                            <i class="bi bi-download me-1"></i>Read from device
                        </button>
                        <button id="btnNvErase" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-1"></i>Erase all
                        </button>
                        <button id="btnNvWrite" class="btn btn-outline-warning">
                            <i class="bi bi-upload me-1"></i>Write to device
                        </button>
                    </div>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col">
                    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"
                        style="height: 1.25rem;">
                        <div id="nvProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                            style="width: 0%">
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="actionsSection" class="section opacity-50 pe-none" aria-disabled="true">
            <h2 class="h6">Actions</h2>
            <div class="small text-muted mb-2">Development actions for the connected device.</div>

            <div class="d-flex justify-content-evenly flex-wrap actions-grid">
                <button id="enterBslBtn" class="btn btn-outline-warning">
                    <i class="bi bi-wrench me-1"></i>Enter BSL
                </button>
                <button id="resetBtn" class="btn btn-outline-success">
                    <i class="bi bi-arrow-clockwise me-1"></i>Reset
                </button>
                <button id="btn-get-model" class="btn btn-outline-primary">
                    <i class="bi bi-cpu me-1"></i>Get Model
                </button>
                <button id="btn-version" class="btn btn-outline-info">
                    <i class="bi bi-info-circle me-1"></i>Get Version
                </button>
                <button id="btn-ping" class="btn btn-outline-dark">
                    <i class="bi bi-wifi me-1"></i>Ping
                </button>
            </div>
        </div>

        <div class="section">



            <div class="d-flex align-items-center justify-content-between mt-2 mb-3">
                <h2 class="h6 mb-0">Logs</h2>

                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <div class="form-check form-switch m-0">
                        <input id="autoScroll" class="form-check-input" type="checkbox" role="switch" checked />
                        <label class="form-check-label" for="autoScroll">Auto scroll</label>
                    </div>
                    <div class="form-check form-switch m-0">
                        <input id="showIo" class="form-check-input" type="checkbox" role="switch" />
                        <label class="form-check-label" for="showIo">Show TX/RX</label>
                    </div>
                    <div class="ms-auto d-flex gap-2">
                        <button id="btnClearLog" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>Clear
                        </button>
                        <button id="btnCopyLog" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                    </div>
                </div>
            </div>
            <div id="consoleWrap" class="console-wrap">
                <div id="log"></div>
            </div>
        </div>

        <footer class="app-footer mt-4 pt-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="small">
                    Created with <span aria-hidden="true">‚ù§Ô∏è</span> by <a href="https://github.com/xyzroe"
                        target="_blank" rel="noopener">xyzroe</a> ¬© 2025
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span id="commitSha" class="text-muted small" title="Last commit SHA"
                        style="letter-spacing:1px"></span>
                    <a href="https://github.com/xyzroe" target="_blank" rel="noopener" aria-label="GitHub"><i
                            class="bi bi-github"></i></a>
                    <a href="https://discord.gg/A5ge3cYRKW" target="_blank" rel="noopener" aria-label="Discord"><i
                            class="bi bi-discord"></i></a>
                    <a href="https://t.me/xzg_fw" target="_blank" rel="noopener" aria-label="Telegram"><i
                            class="bi bi-telegram"></i></a>
                </div>
            </div>
        </footer>

        <!-- Bootstrap JS (tooltips, etc.) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script type="module" src="index.js"></script>

        <script type="module" src="flasher.js"></script>

        <script>
            // SHA –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ
            document.addEventListener('DOMContentLoaded', function () {
                var sha = 'COMMITSHA_PLACEHOLDER';
                var el = document.getElementById('commitSha');
                if (el && sha) {
                    el.innerHTML = `Commit ${sha}`;
                }
            });
        </script>

        <!-- Bridge info modal (lightweight) -->
        <div id="bridgeInfoModal" class="modal-backdrop-lite d-none" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal-card-lite" role="document" aria-labelledby="bridgeInfoTitle">
                <div class="modal-header d-flex align-items-center justify-content-between">
                    <h3 id="bridgeInfoTitle" class="h6 m-0">
                        <i class="bi bi-info-circle me-1"></i>
                        WS‚ÜîTCP Bridge
                    </h3>
                    <button id="bridgeInfoCloseX" class="btn btn-sm btn-outline-secondary" aria-label="Close">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="max-height:50vh;overflow:auto;">
                    <p class="mb-2"></p>
                    To use TCP mode, you must run a local proxy daemon: bridge.
                    </p>

                    <p class="mb-1"><strong><em>Why:</em></strong></p>
                    <ul class="mb-2">
                        <li>Browsers cannot open raw TCP sockets.</li>
                        <li>The bridge exposes a WebSocket endpoint the page connects to and forwards traffic to the
                            TCP
                            device.</li>
                    </ul>

                    <p class="mb-1"><strong><em>What it provides:</em></strong></p>
                    <ul class="mb-2">
                        <li>WebSocket ‚Üî TCP forwarding.</li>
                        <li>mDNS (zeroconf) device discovery.</li>
                        <li>Expose local serial ports as TCP servers with HTTP based DTR/RTS control.</li>
                    </ul>

                    <p class="mb-1"><strong><em>Available installation options:</em></strong></p>
                    <ul class="mb-2">
                        <li>Home Assistant Add-On</li>
                        <li>Docker</li>
                        <li>Prebuilt binaries: Windows, macOS, Linux</li>
                        <li>Node.js</li>
                    </ul>

                    <p class="mb-0">
                        Project page:
                        <a href="https://github.com/xyzroe/bridge" target="_blank" rel="noopener">
                            xyzroe/bridge
                        </a>
                    </p>
                </div>
                <div class="modal-footer">
                    <button id="bridgeInfoClose" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- Firmware notes modal -->
        <div id="fwNotesModal" class="modal-backdrop-lite d-none" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal-card-lite" role="document" aria-labelledby="fwNotesTitle">
                <div class="modal-header d-flex align-items-center justify-content-between">
                    <h3 id="fwNotesTitle" class="h6 m-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Firmware Info
                    </h3>
                    <button id="fwNotesCloseX" class="btn btn-sm btn-outline-secondary" aria-label="Close">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="fwNotesContent" style="max-height:50vh;overflow:auto;"></div>
                </div>
                <div class="modal-footer">
                    <button id="fwNotesClose" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>

    </div>
    </div>
    </div>
</body>

</html>