name: Release Notification

on:
  release:
    types: [published]  
  workflow_dispatch:  

permissions:
  contents: read

jobs:
  prepare:
    name: Prepare Notification Assets
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.release_data.outputs.version }}
      url: ${{ steps.release_data.outputs.url }}
      title: ${{ steps.release_data.outputs.title }}
    steps:
      - name: Get release data
        id: release_data
        run: |
          API_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          VERSION=$(echo "$API_RESPONSE" | jq -r '.tag_name')
          RELEASE_URL=$(echo "$API_RESPONSE" | jq -r '.html_url')
          
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$RELEASE_URL" >> "$GITHUB_OUTPUT"
          echo "title=üéâ New Release of MT" >> "$GITHUB_OUTPUT"

      - name: Download OpenGraph image
        run: |
          IMAGE_URL="https://opengraph.githubassets.com/0.1.0/${{ github.repository }}/releases/tag/${{ steps.release_data.outputs.version }}"
          echo "üì• Downloading OpenGraph image from: $IMAGE_URL"
          
          # Try to download with retries (in case image is still generating)
          for i in {1..5}; do
            if curl -s -L -o release-image.png "$IMAGE_URL"; then
              if [ -s release-image.png ]; then
                if file --mime-type release-image.png | grep -q "image/"; then
                  echo "‚úÖ Image downloaded successfully (attempt $i)"
                  ls -lh release-image.png
                  break
                else
                  echo "‚ö†Ô∏è Downloaded file is not an image (attempt $i)"
                  cat release-image.png
                fi
              fi
            fi
            echo "‚è≥ Attempt $i failed, waiting 3 seconds..."
            sleep 3
          done
          
          if [ ! -f release-image.png ] || ! file --mime-type release-image.png | grep -q "image/"; then
            echo "‚ùå Failed to download a valid image."
            exit 1
          fi

      - name: Upload release image
        uses: actions/upload-artifact@v4
        with:
          name: release-image
          path: release-image.png
          retention-days: 1

  notify-telegram:
    name: Send Telegram Notification
    needs: prepare
    runs-on: ubuntu-latest
    if: success()
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: Download release image
        uses: actions/download-artifact@v4
        with:
          name: release-image

      - name: Send Telegram Notification about release
        if: env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          photo: release-image.png
          message: |
            *${{ needs.prepare.outputs.title }}: ${{ needs.prepare.outputs.version }}*
            
            [View on GitHub](${{ needs.prepare.outputs.url }})

  notify-discord:
    name: Send Discord Notification
    needs: prepare
    runs-on: ubuntu-latest
    if: success()
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - name: Download release image
        uses: actions/download-artifact@v4
        with:
          name: release-image

      - name: Send Discord Notification
        if: env.DISCORD_WEBHOOK != ''
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: ${{ needs.prepare.outputs.title }}
          embed-description: ${{ needs.prepare.outputs.version }}
          embed-url: ${{ needs.prepare.outputs.url }}
          embed-color: 3066993
          embed-image-url: attachment://release-image.png
          filename: release-image.png
