name: Release Notification

on:
  release:
    types: [published]  
  workflow_dispatch:  

permissions:
  contents: read

jobs:
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    if: success()
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - name: Get release data
        id: release_data
        run: |
          API_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          VERSION=$(echo "$API_RESPONSE" | jq -r '.tag_name')
          RELEASE_URL=$(echo "$API_RESPONSE" | jq -r '.html_url')
          
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$RELEASE_URL" >> "$GITHUB_OUTPUT"
          echo "title=üéâ New Release of MT" >> "$GITHUB_OUTPUT"

      - name: Download OpenGraph image
        run: |
          IMAGE_URL="https://opengraph.githubassets.com/0.1.0/${{ github.repository }}/releases/tag/${{ steps.release_data.outputs.version }}"
          echo "üì• Downloading OpenGraph image from: $IMAGE_URL"
          
          # Try to download with retries (in case image is still generating)
          for i in {1..5}; do
            if curl -s -L -o release-image.png "$IMAGE_URL"; then
              if [ -s release-image.png ]; then
                echo "‚úÖ Image downloaded successfully (attempt $i)"
                ls -lh release-image.png
                break
              fi
            fi
            echo "‚è≥ Attempt $i failed, waiting 3 seconds..."
            sleep 3
          done

      - name: Send Telegram Notification about release
        uses: appleboy/telegram-action@master
        if: env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            *${{ steps.release_data.outputs.title }}: ${{ steps.release_data.outputs.version }}*
            
            [View on GitHub](${{ steps.release_data.outputs.url }})
          photo: release-image.png

      - name: Send Discord Notification
        if: env.DISCORD_WEBHOOK != ''
        run: |
          # Upload image to Discord and get URL
          IMAGE_UPLOAD=$(curl -s -F "file=@release-image.png" "$DISCORD_WEBHOOK/slack" | jq -r '.attachments[0].url // empty')
          
          if [ -n "$IMAGE_UPLOAD" ]; then
            # Send with uploaded image
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d @- << EOF
          {
            "embeds": [{
              "title": "${{ steps.release_data.outputs.title }}",
              "description": "${{ steps.release_data.outputs.version }}",
              "url": "${{ steps.release_data.outputs.url }}",
              "color": 3066993,
              "image": {
                "url": "$IMAGE_UPLOAD"
              }
            }]
          }
          EOF
          else
            # Fallback: send without image
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d @- << EOF
          {
            "embeds": [{
              "title": "${{ steps.release_data.outputs.title }}",
              "description": "${{ steps.release_data.outputs.version }}",
              "url": "${{ steps.release_data.outputs.url }}",
              "color": 3066993
            }]
          }
          EOF
          fi
          echo "‚úÖ Discord notification sent"
