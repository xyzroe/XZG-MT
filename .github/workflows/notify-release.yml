name: Release Notification

on:
  release:
    types: [published]  
  workflow_dispatch:  

permissions:
  contents: read

jobs:
  prepare:
    name: Prepare Notification Assets
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.release_data.outputs.version }}
      url: ${{ steps.release_data.outputs.url }}
      title: ${{ steps.release_data.outputs.title }}
    steps:
      - name: Get release data
        id: release_data
        run: |
          API_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          VERSION=$(echo "$API_RESPONSE" | jq -r '.tag_name')
          RELEASE_URL=$(echo "$API_RESPONSE" | jq -r '.html_url')
          
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$RELEASE_URL" >> "$GITHUB_OUTPUT"
          echo "title=üéâ New Release of MT" >> "$GITHUB_OUTPUT"

      - name: Download OpenGraph image
        run: |
          IMAGE_URL="https://opengraph.githubassets.com/0.1.0/${{ github.repository }}/releases/tag/${{ steps.release_data.outputs.version }}"
          echo "üì• Downloading OpenGraph image from: $IMAGE_URL"
          
          # Try to download with retries (in case image is still generating)
          for i in {1..5}; do
            if curl -s -L -o release-image.png "$IMAGE_URL"; then
              if [ -s release-image.png ]; then
                if file --mime-type release-image.png | grep -q "image/"; then
                  echo "‚úÖ Image downloaded successfully (attempt $i)"
                  ls -lh release-image.png
                  break
                else
                  echo "‚ö†Ô∏è Downloaded file is not an image (attempt $i)"
                  cat release-image.png
                fi
              fi
            fi
            echo "‚è≥ Attempt $i failed, waiting $((i*3)) seconds..."
            sleep $((i*3))
          done
          
          if [ ! -f release-image.png ] || ! file --mime-type release-image.png | grep -q "image/"; then
            echo "‚ùå Failed to download a valid image."
            exit 1
          fi

      - name: Upload release image
        uses: actions/upload-artifact@v4
        with:
          name: release-image
          path: release-image.png
          retention-days: 1

  notify-telegram:
    name: Send Telegram Notification
    needs: prepare
    runs-on: ubuntu-latest
    if: success()
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
    steps:
      - name: Download release image
        uses: actions/download-artifact@v4
        with:
          name: release-image

      - name: Send Telegram Notification about release
        if: env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != '' && env.TELEGRAM_THREAD_ID != ''
        run: |
          CAPTION=$'*${{ needs.prepare.outputs.title }}: ${{ needs.prepare.outputs.version }}*\n\n[View on GitHub](${{ needs.prepare.outputs.url }})'
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
            -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F message_thread_id="${{ secrets.TELEGRAM_THREAD_ID }}" \
            -F parse_mode="Markdown" \
            -F photo="@release-image.png" \
            -F caption="$CAPTION"

  notify-discord:
    name: Send Discord Notification
    needs: prepare
    runs-on: ubuntu-latest
    if: success()
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - name: Download release image
        uses: actions/download-artifact@v4
        with:
          name: release-image

      - name: Send Discord Notification
        if: env.DISCORD_WEBHOOK != ''
        run: |
          # Construct JSON payload using jq to handle escaping safely
          JSON_PAYLOAD=$(jq -n \
            --arg title "${{ needs.prepare.outputs.title }}" \
            --arg version "${{ needs.prepare.outputs.version }}" \
            --arg url "${{ needs.prepare.outputs.url }}" \
            '{
              embeds: [{
                title: $title,
                description: ($version + "\n\n[View on GitHub](" + $url + ")"),
                color: 3066993,
                image: { url: "attachment://release-image.png" }
              }]
            }')
          
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -F "file=@release-image.png" \
            -F "payload_json=$JSON_PAYLOAD"
