name: Build CCLoader firmware

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'Board type / модель платы'
        type: choice
        default: arduino_uno
        options:
          - arduino_uno        # Arduino Uno R3
          - arduino_nano       # Arduino Nano (ATmega328P, new bootloader)
          - arduino_mega       # Arduino Mega 2560
          - arduino_micro      # Arduino Micro
          - d1_mini            # Wemos D1 mini (ESP8266)
          - nodemcu            # NodeMCU 1.0 (ESP-12E)
          - esp32_dev          # ESP32 Dev Module
          - esp32c3_dev        # ESP32-C3 Dev Module
          - esp32s3_dev        # ESP32-S3 Dev Module
      dc_pin:
        description: 'DC pin number'
        required: true
        type: string
        default: "5"
      dd_pin:
        description: 'DD pin number'
        required: true
        type: string
        default: "6"
      reset_pin:
        description: 'RESET pin number'
        required: true
        type: string
        default: "4"
      led_pin:
        description: 'LED pin number'
        required: true
        type: string
        default: "13"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Select board FQBN
        run: |
          case "${{ github.event.inputs.board }}" in
            arduino_uno)
              echo "FQBN=arduino:avr:uno" >> $GITHUB_ENV
              echo "CORE=arduino:avr" >> $GITHUB_ENV
              NAME="arduino_uno"
              ;;
            arduino_nano)
              # Nano с новым бутлоадером
              echo "FQBN=arduino:avr:nano" >> $GITHUB_ENV
              echo "CORE=arduino:avr" >> $GITHUB_ENV
              NAME="arduino_nano"
              ;;
            arduino_mega)
              echo "FQBN=arduino:avr:mega" >> $GITHUB_ENV
              echo "CORE=arduino:avr" >> $GITHUB_ENV
              NAME="arduino_mega2560"
              ;;
            arduino_micro)
              echo "FQBN=arduino:avr:micro" >> $GITHUB_ENV
              echo "CORE=arduino:avr" >> $GITHUB_ENV
              NAME="arduino_micro"
              ;;
            d1_mini)
              echo "FQBN=esp8266:esp8266:d1_mini" >> $GITHUB_ENV
              echo "CORE=esp8266:esp8266" >> $GITHUB_ENV
              NAME="d1_mini"
              ;;
            nodemcu)
              echo "FQBN=esp8266:esp8266:nodemcuv2" >> $GITHUB_ENV
              echo "CORE=esp8266:esp8266" >> $GITHUB_ENV
              NAME="nodemcu"
              ;;
            esp32_dev)
              echo "FQBN=esp32:esp32:esp32" >> $GITHUB_ENV
              echo "CORE=esp32:esp32" >> $GITHUB_ENV
              NAME="esp32_dev"
              ;;
            esp32c3_dev)
              echo "FQBN=esp32:esp32:esp32c3" >> $GITHUB_ENV
              echo "CORE=esp32:esp32" >> $GITHUB_ENV
              NAME="esp32c3_dev"
              ;;
            esp32s3_dev)
              echo "FQBN=esp32:esp32:esp32s3" >> $GITHUB_ENV
              echo "CORE=esp32:esp32" >> $GITHUB_ENV
              NAME="esp32s3_dev"
              ;;
            *)
              echo "Unsupported board: ${{ github.event.inputs.board }}"
              exit 1
              ;;
          esac
          echo "BOARD_NAME=$NAME" >> $GITHUB_ENV

      - name: Install board core
        run: |
          arduino-cli core update-index
          arduino-cli core install "$CORE"

      - name: Patch pins in CCLoader.ino
        working-directory: src
        run: |
          # Заменяем значения пинов на те, что переданы во входных параметрах
          sed -i 's/int DD = [0-9]\+/int DD = ${{ github.event.inputs.dd_pin }}/' CCLoader.ino
          sed -i 's/int DC = [0-9]\+/int DC = ${{ github.event.inputs.dc_pin }}/' CCLoader.ino
          sed -i 's/int RESET = [0-9]\+/int RESET = ${{ github.event.inputs.reset_pin }}/' CCLoader.ino
          # LED может быть числом или LED_BUILTIN — просто перезапишем строку
          sed -i 's/int LED = .*/int LED = ${{ github.event.inputs.led_pin }};/' CCLoader.ino

      - name: Compile sketch
        run: |
          arduino-cli compile \
            --fqbn "$FQBN" \
            --export-binaries \
            --output-dir build \
            src

      - name: Convert HEX to BIN for AVR (if needed)
        run: |
          HEX_FILE=$(find build -name '*.hex' -print -quit || true)
          if [ -n "$HEX_FILE" ]; then
            echo "Found HEX: $HEX_FILE"
            AVR_OBJCOPY=$(find ~/.arduino15 -name avr-objcopy -print -quit || true)
            if [ -z "$AVR_OBJCOPY" ]; then
              echo "avr-objcopy not found"
              exit 1
            fi
            BIN_FILE="${HEX_FILE%.hex}.bin"
            "$AVR_OBJCOPY" -I ihex -O binary "$HEX_FILE" "$BIN_FILE"
            echo "Generated BIN: $BIN_FILE"
          else
            echo "No HEX found, likely non-AVR board, using existing .bin from build"
          fi

      - name: Prepare artifact
        run: |
          mkdir -p artifacts
          BIN_SRC=$(find build -name '*.bin' -print -quit)
          if [ -z "$BIN_SRC" ]; then
            echo "No BIN file produced"
            exit 1
          fi

          OUT_NAME="CCLoader_${BOARD_NAME}_dc${{ github.event.inputs.dc_pin }}_dd${{ github.event.inputs.dd_pin }}_reset${{ github.event.inputs.reset_pin }}_led${{ github.event.inputs.led_pin }}.bin"
          cp "$BIN_SRC" "artifacts/$OUT_NAME"
          echo "Final BIN: artifacts/$OUT_NAME"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: CCLoader-firmware
          path: artifacts/*.bin
