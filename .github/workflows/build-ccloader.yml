name: Build CCLoader firmware

permissions:
  contents: write

on:
  push:
    branches:
      - cc_loader
    paths:
      - 'task.json'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: cc_loader

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Add board manager URLs
        run: |
          arduino-cli config init --overwrite
          arduino-cli config add board_manager.additional_urls https://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      - name: Install all required cores
        run: |
          # Read task.json and determine which cores are needed
          BOARDS=$(cat task.json | jq -r '.builds[].board' | sort -u)
          
          CORES_TO_INSTALL=""
          for board in $BOARDS; do
            case "$board" in
              d1_mini|nodemcu)
                if [[ ! "$CORES_TO_INSTALL" =~ "esp8266:esp8266" ]]; then
                  CORES_TO_INSTALL="$CORES_TO_INSTALL esp8266:esp8266"
                fi
                ;;
              esp32_dev|esp32c3_dev|esp32s3_dev)
                if [[ ! "$CORES_TO_INSTALL" =~ "esp32:esp32" ]]; then
                  CORES_TO_INSTALL="$CORES_TO_INSTALL esp32:esp32"
                fi
                ;;
            esac
          done
          
          arduino-cli core update-index
          
          for core in $CORES_TO_INSTALL; do
            echo "Installing $core..."
            arduino-cli core install "$core"
          done

      - name: Install esptool
        run: pip install esptool

      - name: Build all configurations
        run: |
          mkdir -p bins
          
          # Read all configurations from task.json
          CONFIGS=$(cat task.json | jq -c '.builds[]')
          
          while IFS= read -r config; do
            BOARD=$(echo "$config" | jq -r '.board')
            DC_PIN=$(echo "$config" | jq -r '.dc_pin')
            DD_PIN=$(echo "$config" | jq -r '.dd_pin')
            RESET_PIN=$(echo "$config" | jq -r '.reset_pin')
            LED_PIN=$(echo "$config" | jq -r '.led_pin')
            
            echo "========================================="
            echo "Building configuration:"
            echo "Board: $BOARD"
            echo "Pins: DC=$DC_PIN, DD=$DD_PIN, RESET=$RESET_PIN, LED=$LED_PIN"
            echo "========================================="
            
            # Determine FQBN, board name, and chip
            case "$BOARD" in
              d1_mini)
                FQBN="esp8266:esp8266:d1_mini"
                BOARD_NAME="d1_mini"
                CHIP="ESP8266"
                ;;
              nodemcu)
                FQBN="esp8266:esp8266:nodemcuv2"
                BOARD_NAME="nodemcu"
                CHIP="ESP8266"
                ;;
              esp32_dev)
                FQBN="esp32:esp32:esp32"
                BOARD_NAME="esp32_dev"
                CHIP="ESP32"
                ;;
              esp32c3_dev)
                FQBN="esp32:esp32:esp32c3"
                BOARD_NAME="esp32c3_dev"
                CHIP="ESP32-C3"
                ;;
              esp32s3_dev)
                FQBN="esp32:esp32:esp32s3"
                BOARD_NAME="esp32s3_dev"
                CHIP="ESP32-S3"
                ;;
              *)
                echo "Unsupported board: $BOARD"
                continue
                ;;
            esac
            
            # Create a temporary copy of the sketch
            TEMP_SKETCH_DIR="Arduino/CCLoader_temp_$$"
            mkdir -p "$TEMP_SKETCH_DIR"
            cp Arduino/CCLoader/CCLoader.ino "$TEMP_SKETCH_DIR/CCLoader_temp_$$.ino"
            
            # Patch pins
            sed -i "s/int DD = [0-9]\+/int DD = $DD_PIN/" "$TEMP_SKETCH_DIR/CCLoader_temp_$$.ino"
            sed -i "s/int DC = [0-9]\+/int DC = $DC_PIN/" "$TEMP_SKETCH_DIR/CCLoader_temp_$$.ino"
            sed -i "s/int RESET = [0-9]\+/int RESET = $RESET_PIN/" "$TEMP_SKETCH_DIR/CCLoader_temp_$$.ino"
            sed -i "s/int LED = .*/int LED = $LED_PIN;/" "$TEMP_SKETCH_DIR/CCLoader_temp_$$.ino"
            
            # Compile
            BUILD_DIR="build_${BOARD_NAME}_$$"
            mkdir -p "$BUILD_DIR"
            
            arduino-cli compile \
              --fqbn "$FQBN" \
              --export-binaries \
              --output-dir "$BUILD_DIR" \
              "$TEMP_SKETCH_DIR"
            
            # Form the output file name
            OUT_NAME="CCLoader_${BOARD_NAME}_dc-${DC_PIN}_dd-${DD_PIN}_reset-${RESET_PIN}_led-${LED_PIN}.bin"
            
            # Process the binary depending on the board type
            if [[ "$BOARD" == esp32* ]]; then
              # ESP32: merge all parts
              APP_BIN=$(find "$BUILD_DIR" -name '*.ino.bin' -print -quit)
              BOOTLOADER=$(find "$BUILD_DIR" -name '*bootloader*.bin' -print -quit)
              PARTITIONS=$(find "$BUILD_DIR" -name '*partitions*.bin' -print -quit)
              BOOT_APP0=$(find "$BUILD_DIR" -name '*boot_app0*.bin' -print -quit)
              
              if [ -z "$APP_BIN" ] || [ -z "$BOOTLOADER" ] || [ -z "$PARTITIONS" ]; then
                echo "Error: Missing ESP32 binary files"
                ls -la "$BUILD_DIR"/
                rm -rf "$TEMP_SKETCH_DIR" "$BUILD_DIR"
                continue
              fi
              
              case "$BOARD" in
                esp32_dev) ESPTOOL_CHIP="esp32" ;;
                esp32c3_dev) ESPTOOL_CHIP="esp32c3" ;;
                esp32s3_dev) ESPTOOL_CHIP="esp32s3" ;;
                esp32c6_dev) ESPTOOL_CHIP="esp32c6" ;;
              esac
              
              if [ -n "$BOOT_APP0" ]; then
                esptool.py --chip $ESPTOOL_CHIP merge_bin \
                  -o "bins/$OUT_NAME" \
                  --flash_mode dio \
                  --flash_size 4MB \
                  0x1000 "$BOOTLOADER" \
                  0x8000 "$PARTITIONS" \
                  0xe000 "$BOOT_APP0" \
                  0x10000 "$APP_BIN"
              else
                esptool.py --chip $ESPTOOL_CHIP merge_bin \
                  -o "bins/$OUT_NAME" \
                  --flash_mode dio \
                  --flash_size 4MB \
                  0x1000 "$BOOTLOADER" \
                  0x8000 "$PARTITIONS" \
                  0x10000 "$APP_BIN"
              fi
            else
              # ESP8266: copy the ready BIN
              BIN_SRC=$(find "$BUILD_DIR" -name '*.bin' -print -quit)
              if [ -z "$BIN_SRC" ]; then
                echo "Error: No BIN file produced"
                rm -rf "$TEMP_SKETCH_DIR" "$BUILD_DIR"
                continue
              fi
              cp "$BIN_SRC" "bins/$OUT_NAME"
            fi
            
            echo "âœ“ Created: $OUT_NAME ($(stat -c%s "bins/$OUT_NAME" 2>/dev/null || stat -f%z "bins/$OUT_NAME") bytes)"
            
            # Clean up temporary files
            rm -rf "$TEMP_SKETCH_DIR" "$BUILD_DIR"
            
          done <<< "$CONFIGS"
          
          echo "========================================="
          echo "Build complete! Generated files:"
          ls -lh bins/
          echo "========================================="

      - name: Generate manifest.json
        run: |
          cat > bins/manifest.json << 'EOF'
          {
            "firmwares": []
          }
          EOF
          
          # Read configurations from task.json
          CONFIGS=$(cat task.json | jq -c '.builds[]')
          
          # Create an array for the manifest
          MANIFEST_ITEMS="[]"
          
          while IFS= read -r config; do
            BOARD=$(echo "$config" | jq -r '.board')
            DC_PIN=$(echo "$config" | jq -r '.dc_pin')
            DD_PIN=$(echo "$config" | jq -r '.dd_pin')
            RESET_PIN=$(echo "$config" | jq -r '.reset_pin')
            LED_PIN=$(echo "$config" | jq -r '.led_pin')
            
            # Determine the file name and chip
            case "$BOARD" in
              d1_mini)
                BOARD_NAME="d1_mini"
                CHIP="ESP8266"
                ;;
              nodemcu)
                BOARD_NAME="nodemcu"
                CHIP="ESP8266"
                ;;
              esp32_dev)
                BOARD_NAME="esp32_dev"
                CHIP="ESP32"
                ;;
              esp32c3_dev)
                BOARD_NAME="esp32c3_dev"
                CHIP="ESP32-C3"
                ;;
              esp32s3_dev)
                BOARD_NAME="esp32s3_dev"
                CHIP="ESP32-S3"
                ;;
              esp32c6_dev)
                BOARD_NAME="esp32c6_dev"
                CHIP="ESP32-C6"
                ;;
            esac
            
            FILENAME="CCLoader_${BOARD_NAME}_dc-${DC_PIN}_dd-${DD_PIN}_reset-${RESET_PIN}_led-${LED_PIN}.bin"
            
            # Check that the file exists
            if [ ! -f "bins/$FILENAME" ]; then
              echo "Warning: $FILENAME not found, skipping"
              continue
            fi
            
            # Add an entry to the manifest
            ITEM=$(jq -n \
              --arg filename "$FILENAME" \
              --arg url "https://raw.githubusercontent.com/xyzroe/XZG-MT/cc_loader/bins/$FILENAME" \
              --arg board "$BOARD" \
              --arg chip "$CHIP" \
              --arg dc "$DC_PIN" \
              --arg dd "$DD_PIN" \
              --arg reset "$RESET_PIN" \
              --arg led "$LED_PIN" \
              '{
                filename: $filename,
                url: $url,
                board: $board,
                chip: $chip,
                pins: {
                  dc: $dc,
                  dd: $dd,
                  reset: $reset,
                  led: $led
                }
              }')
            
            MANIFEST_ITEMS=$(echo "$MANIFEST_ITEMS" | jq --argjson item "$ITEM" '. += [$item]')
          done <<< "$CONFIGS"
          
          # Write the final manifest
          jq --argjson items "$MANIFEST_ITEMS" '.firmwares = $items' bins/manifest.json > bins/manifest.json.tmp
          mv bins/manifest.json.tmp bins/manifest.json
          
          echo "Generated manifest.json:"
          cat bins/manifest.json

      - name: Commit and push binaries
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bins/ -f
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-build: Update CCLoader binaries [skip ci]"
            git push
          fi
